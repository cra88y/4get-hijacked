services:
  searxng:
    image: 'ghcr.io/searxng/searxng:latest'
    container_name: searxng
    restart: unless-stopped
    depends_on:
      - valkey
      - 4get-hijacked
    environment:
      - 'INSTANCE_NAME=${INSTANCE_NAME}'
      - 'SEARXNG_BASE_URL=https://${SERVICE_FQDN_SEARXNG}'
      - 'SEARXNG_SECRET=${SERVICE_PASSWORD_SEARXNGSECRET}'
      - 'SEARXNG_REDIS_URL=valkey://valkey:6379/0'
      - 'SEARXNG_VALKEY_URL=valkey://valkey:6379/0'
    volumes:
      - './settings.yml:/etc/searxng/settings.yml:ro'
      - './limiter.toml:/etc/searxng/limiter.toml:ro'
      - '/root/proj/searxng-custom-theme/crabx:/usr/local/searxng/searx/templates/simple'
      - '/root/proj/searxng-custom-theme/crabx-static/css:/usr/local/searxng/searx/static/themes/simple/css'
      - '/root/proj/4get-hijacked/searx/engines:/tmp/custom-engines:ro'
    networks:
      - searxng-net
    command: "sh -c \"\necho 'Starting engine copy process...'\nif [ -d '/tmp/custom-engines' ]; then\n    echo 'Copying custom engines from /tmp/custom-engines...'\n    cp -f /tmp/custom-engines/*.py /usr/local/searxng/searx/engines/ 2>/dev/null || echo 'No .py files found'\nelse\n    echo 'ERROR: /tmp/custom-engines directory not found'\nfi\n\necho 'Verification of engines:'\nls -la /usr/local/searxng/searx/engines/*-4get.py 2>/dev/null || echo 'No 4get engines found'\n\necho 'Launching SearXNG...'\nexec /usr/local/searxng/dockerfiles/docker-entrypoint.sh\n\"\n"
  valkey:
    container_name: valkey
    image: 'docker.io/valkey/valkey:alpine'
    command: 'valkey-server --save 60 1 --loglevel warning'
    restart: unless-stopped
    volumes:
      - 'valkey-data:/data'
    networks:
      - searxng-net
  4get-hijacked:
    build:
      context: /root/proj/4get-hijacked/sidecar
    container_name: 4get-hijacked
    ports:
      - '8081:80'
    restart: unless-stopped
    volumes:
      - '/root/proj/4get-hijacked/sidecar/src:/var/www/html'
    networks:
      - searxng-net
networks:
  searxng-net:
    driver: bridge
volumes:
  valkey-data: null