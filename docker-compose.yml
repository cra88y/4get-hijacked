services:
  searxng:
    user: root
    image: 'ghcr.io/searxng/searxng:latest'
    container_name: searxng
    restart: unless-stopped
    depends_on:
      - valkey
      - 4get-hijacked
    environment:
      - SEARXNG_OUTGOING_HTTP_PROTOCOL_DISABLED=false
      - SEARXNG_OUTGOING_ALLOW_PRIVATE_NETWORKS=true
      - PYTHONPATH=/usr/local/searxng/searx/engines
      - 'INSTANCE_NAME=${INSTANCE_NAME}'
      - 'SEARXNG_BASE_URL=https://${SERVICE_FQDN_SEARXNG}'
      - 'SEARXNG_SECRET=${SERVICE_PASSWORD_SEARXNGSECRET}'
      - 'SEARXNG_REDIS_URL=valkey://valkey:6379/0'
      - 'SEARXNG_VALKEY_URL=valkey://valkey:6379/0'
    volumes:
      - './settings.yml:/etc/searxng/settings.yml:ro'
      - './limiter.toml:/etc/searxng/limiter.toml:ro'
      - '/root/proj/searxng-custom-theme/crabx:/usr/local/searxng/searx/templates/simple'
      - '/root/proj/searxng-custom-theme/crabx-static/css:/usr/local/searxng/searx/static/themes/simple/css'
      - '/root/proj/4get-hijacked/crab-engine/google-crab.py:/usr/local/searxng/searx/engines/google-crab.py'
      - '/root/proj/4get-hijacked/searx/engines:/tmp/custom-engines:ro'
    networks:
      - searxng-net
    entrypoint:
      - /bin/sh
      - '-c'
      - "echo \"--- CUSTOM STARTUP SCRIPT STARTED ---\"\n\nif [ -d '/tmp/custom-engines' ]; then\n    echo \"Found custom engines directory. Copying...\"\n    cp -fv /tmp/custom-engines/*.py /usr/local/searxng/searx/engines/\n    \n    echo \"Fixing permissions...\"\n    chown searxng:searxng /usr/local/searxng/searx/engines/*.py\n    \n    echo \"Verifying copy:\"\n    ls -la /usr/local/searxng/searx/engines/*-4get.py\nelse\n    echo \"ERROR: /tmp/custom-engines directory not found!\"\n    ls -la /tmp/\nfi\n\necho \"--- HANDING OVER TO ORIGINAL ENTRYPOINT ---\"\n# We manually execute the original entrypoint to start the app\nexec /usr/local/searxng/entrypoint.sh\n"
  valkey:
    container_name: valkey
    image: 'docker.io/valkey/valkey:alpine'
    command: 'valkey-server --save 60 1 --loglevel warning'
    restart: unless-stopped
    volumes:
      - 'valkey-data:/data'
    networks:
      - searxng-net
  4get-hijacked:
    build:
      context: /root/proj/4get-hijacked/sidecar
    container_name: 4get-hijacked
    ports:
      - '8081:80'
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health.php || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - searxng-net
networks:
  searxng-net:
    driver: bridge
volumes:
  valkey-data: null
